{% extends "base.html" %}

{% block title %}Dashboard - SkillTracker{% endblock %}

{% block extra_css %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Welcome Section -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>Welcome back, <span class="username-highlight">{{ username }}</span>! ðŸ‘‹</h1>
            <p class="date-display">
                <i class="fas fa-calendar-day"></i>
                <span id="currentDate"></span>
            </p>
        </div>
        <div class="quick-actions">
            <a href="{{ url_for('add_goal') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> Add New Goal
            </a>
        </div>
    </div>

    <!-- Motivational Quote -->
    <div class="quote-card" id="quoteCard">
        <div class="quote-loading">
            <i class="fas fa-spinner fa-spin"></i> Loading inspiration...
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-bullseye"></i>
            </div>
            <div class="stat-info">
                <h3>{{ goals|length }}</h3>
                <p>Active Goals</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon green">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalHours">0</h3>
                <p>Total Hours</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-fire"></i>
            </div>
            <div class="stat-info">
                <h3 id="weekStreak">7</h3>
                <p>Day Streak</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon orange">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <h3 id="weeklyHours">0</h3>
                <p>This Week</p>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="dashboard-grid">
        <!-- Goals Section -->
        <div class="dashboard-section goals-section">
            <div class="section-header">
                <h2><i class="fas fa-target"></i> Your Learning Goals</h2>
            </div>

            {% if goals %}
                <div class="goals-list">
                    {% for goal in goals %}
                    <div class="goal-card">
                        <div class="goal-header">
                            <h3>{{ goal.name }}</h3>
                            <div class="goal-actions">
                                <a href="{{ url_for('log_entry', goal_id=goal.id) }}" 
                                   class="btn-icon" 
                                   title="Add log entry">
                                    <i class="fas fa-plus"></i>
                                </a>
                                <a href="{{ url_for('view_logs', goal_id=goal.id) }}" 
                                   class="btn-icon" 
                                   title="View logs">
                                    <i class="fas fa-list"></i>
                                </a>
                                <a href="{{ url_for('edit_goal', goal_id=goal.id) }}" 
                                   class="btn-icon" 
                                   title="Edit goal">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{{ url_for('delete_goal', goal_id=goal.id) }}" 
                                   class="btn-icon delete" 
                                   title="Delete goal"
                                   onclick="return confirm('Are you sure you want to delete this goal?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                        
                        <div class="goal-info">
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>Target: {{ goal.target_date or 'Not set' }}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>{{ goal.total_hours }} hours logged</span>
                            </div>
                        </div>

                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (goal.total_hours / 50 * 100)|int }}%"></div>
                        </div>
                        <small class="progress-text">Progress towards 50 hours</small>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-lightbulb"></i>
                    <h3>No Goals Yet</h3>
                    <p>Start your learning journey by creating your first goal!</p>
                    <a href="{{ url_for('add_goal') }}" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i> Create First Goal
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Charts Section -->
        <div class="dashboard-section charts-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Weekly Progress</h2>
            </div>
            
            <div class="chart-container">
                <canvas id="weeklyChart"></canvas>
            </div>

            <div class="chart-legend">
                <p><i class="fas fa-circle" style="color: #4f46e5;"></i> Hours studied this week</p>
            </div>
        </div>
    </div>
</div>

<script>
// Display current date
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Calculate total hours
const goals = {{ goals|tojson }};
let totalHours = 0;
goals.forEach(goal => {
    totalHours += goal.total_hours;
});
document.getElementById('totalHours').textContent = totalHours.toFixed(1);

// Fetch and display motivational quote with cache busting
function loadQuote() {
    const quoteCard = document.getElementById('quoteCard');
    quoteCard.innerHTML = '<div class="quote-loading"><i class="fas fa-spinner fa-spin"></i> Loading inspiration...</div>';
    
    // Add random parameter and timestamp to bust ALL caching
    const randomParam = Math.random().toString(36).substring(7);
    const timestamp = new Date().getTime();
    
    fetch(`https://api.quotable.io/random?tags=inspirational&maxLength=150&t=${timestamp}&r=${randomParam}`, {
        cache: 'no-store',
        headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
        }
    })
        .then(response => response.json())
        .then(data => {
            quoteCard.innerHTML = `
                <div class="quote-content">
                    <i class="fas fa-quote-left quote-icon"></i>
                    <p class="quote-text">${data.content}</p>
                    <p class="quote-author">â€” ${data.author}</p>
                    <button onclick="loadQuote()" class="btn btn-outline" style="margin-top: 1rem;">
                        <i class="fas fa-sync-alt"></i> New Quote
                    </button>
                </div>
            `;
        })
        .catch(error => {
            console.error('Quote API error:', error);
            const fallbackQuotes = [
                { content: "The beautiful thing about learning is that no one can take it away from you.", author: "B.B. King" },
                { content: "Education is the most powerful weapon which you can use to change the world.", author: "Nelson Mandela" },
                { content: "The expert in anything was once a beginner.", author: "Helen Hayes" },
                { content: "Learning never exhausts the mind.", author: "Leonardo da Vinci" },
                { content: "The more that you read, the more things you will know.", author: "Dr. Seuss" },
                { content: "Live as if you were to die tomorrow. Learn as if you were to live forever.", author: "Mahatma Gandhi" },
                { content: "An investment in knowledge pays the best interest.", author: "Benjamin Franklin" },
                { content: "The only way to do great work is to love what you do.", author: "Steve Jobs" }
            ];
            
            const randomQuote = fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)];
            
            quoteCard.innerHTML = `
                <div class="quote-content">
                    <i class="fas fa-quote-left quote-icon"></i>
                    <p class="quote-text">${randomQuote.content}</p>
                    <p class="quote-author">â€” ${randomQuote.author}</p>
                    <button onclick="loadQuote()" class="btn btn-outline" style="margin-top: 1rem;">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
        });
}

// Make loadQuote available globally
window.loadQuote = loadQuote;

// Load quote on page load
loadQuote();

// Fetch weekly data and create chart
fetch('/api/weekly_data')
    .then(response => response.json())
    .then(data => {
        console.log('Weekly data received:', data);
        
        // Update weekly hours stat
        const weeklyTotal = data.hours.reduce((a, b) => a + b, 0);
        document.getElementById('weeklyHours').textContent = weeklyTotal.toFixed(1);

        // Prepare labels
        const labels = data.dates.length > 0 
            ? data.dates.map(date => {
                const d = new Date(date + 'T00:00:00');
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
              })
            : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // Prepare data
        const chartData = data.hours.length > 0 ? data.hours : [0, 0, 0, 0, 0, 0, 0];

        // Create chart
        const ctx = document.getElementById('weeklyChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Hours Studied',
                        data: chartData,
                        backgroundColor: '#4f46e5',
                        borderColor: '#4338ca',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    return 'Hours: ' + context.parsed.y.toFixed(1);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + 'h';
                                }
                            },
                            grid: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    })
    .catch(error => {
        console.error('Error fetching weekly data:', error);
        document.getElementById('weeklyHours').textContent = '0';
        
        // Still create chart with empty data
        const ctx = document.getElementById('weeklyChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Hours Studied',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: '#4f46e5',
                        borderColor: '#4338ca',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}